<api xmlns="http://ws.apache.org/ns/synapse"
     name="NameCheckAPI"
     context="/transfer">
    <resource methods="POST" uri-template="/">
        <inSequence>
            <!-- Extract and log incoming payload -->
            <property name="RequestRefID" expression="json-eval($.RequestRefID)" scope="default" type="STRING"/>
            <property name="CommandID" expression="json-eval($.CommandID)" scope="default" type="STRING"/>
            <property name="SourceSystem" expression="json-eval($.SourceSystem)" scope="default" type="STRING"/>
            <property name="Version" expression="json-eval($.Version)" scope="default" type="STRING"/>
            <property name="Remark" expression="json-eval($.Remark)" scope="default" type="STRING"/>
            <property name="Timestamp" expression="json-eval($.Timestamp)" scope="default" type="STRING"/>
            <property name="AppVersion" expression="json-eval($.ReferenceData[0].Value)" scope="default" type="STRING"/>
            <property name="IdentifierType" expression="json-eval($.ReceiverParty.IdentifierType)" scope="default" type="STRING"/>
            <property name="Identifier" expression="json-eval($.ReceiverParty.Identifier)" scope="default" type="STRING"/>

            <!-- Call the TokenAPI to get the access token -->
            <property name="Authorization" expression="fn:concat('Basic ', base64Encode('jgdPJACy5TPGniKsmxahZgjYsfCn9ILI2LZanmk5kukRycGd:nLIqp5u77VqO2TKshWYAOaG33sMiCkGh7g6NOcnLKFsoneFpwnwskDaOMWs4Vgc1'))" scope="transport"/>
            <log level="full"/>
            <call>
                <endpoint>
                    <http method="GET" uri-template="https://apisandbox.safaricom.et/v1/token/generate?grant_type=client_credentials"/>
                </endpoint>
            </call>
            <property name="access_token" expression="json-eval($.access_token)" scope="default" type="STRING"/>
            <property name="Authorization" expression="fn:concat('Bearer ', get-property('access_token'))" scope="transport"/>
            <log level="custom">
                <property name="Token" expression="get-property('access_token')"/>
            </log>

            <!-- Set the JSON payload for the final API call -->
            <payloadFactory media-type="json">
                <format>{
                    "RequestRefID": "$1",
                    "CommandID": "$2",
                    "SourceSystem": "$3",
                    "Version": "$4",
                    "Remark": "$5",
                    "Timestamp": "$6",
                    "ReferenceData": [
                        {
                            "Key": "AppVersion",
                            "Value": "$7"
                        }
                    ],
                    "ReceiverParty": {
                        "IdentifierType": "$8",
                        "Identifier": "$9"
                    }
                }</format>
                <args>
                    <arg evaluator="xml" expression="get-property('RequestRefID')"/>
                    <arg evaluator="xml" expression="get-property('CommandID')"/>
                    <arg evaluator="xml" expression="get-property('SourceSystem')"/>
                    <arg evaluator="xml" expression="get-property('Version')"/>
                    <arg evaluator="xml" expression="get-property('Remark')"/>
                    <arg evaluator="xml" expression="get-property('Timestamp')"/>
                    <arg evaluator="xml" expression="get-property('AppVersion')"/>
                    <arg evaluator="xml" expression="get-property('IdentifierType')"/>
                    <arg evaluator="xml" expression="get-property('Identifier')"/>
                </args>
            </payloadFactory>
            <log level="full"/>
            
            <call>
                <endpoint>
                    <http method="POST" uri-template="https://apisandbox.safaricom.et/mpesa/banktompesa/v1/namecheck"/>
                </endpoint>
            </call>
            <log level="full"/>
            <respond/>
        </inSequence>
        <faultSequence>
            <log level="full">
                <property name="Error" value="Error in Name Check API"/>
            </log>
            <respond/>
        </faultSequence>
    </resource>
</api>
